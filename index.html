<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨ç”»è‹±è¯­è·Ÿè¯»æ‰“å¡ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #10B981;
            --primary-light: #A7F3D0;
            --success: #059669;
            --warning: #F59E0B;
            --error: #EF4444;
            --background: #F0FDF4;
            --surface: #FFFFFF;
            --text: #064E3B;
            --text-light: #6B7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            background: var(--surface);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .subtitle {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 30px;
        }

        /* åŠ¨ç”»æ’­æ”¾å™¨åŒºåŸŸ */
        .video-section {
            margin-bottom: 30px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #animationVideo {
            width: 100%;
            height: 300px;
            background: #000;
        }

        .subtitle-display {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .current-subtitle {
            font-weight: 600;
            color: #FFD700;
        }

        /* å°è¯åˆ—è¡¨ */
        .dialogues-section {
            margin-bottom: 30px;
        }

        .dialogue-item {
            background: var(--surface);
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .dialogue-item:hover {
            border-color: var(--primary-light);
        }

        .dialogue-item.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-light) 0%, #E6F3FF 100%);
        }

        .dialogue-item.completed {
            border-color: var(--success);
            background: #F0FFF4;
        }

        .dialogue-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .character {
            font-weight: 600;
            color: var(--primary);
        }

        .dialogue-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #E2E8F0;
        }

        .status-pending {
            background: #FEF3C7;
            color: var(--warning);
        }

        .status-completed {
            background: #D1FAE5;
            color: var(--success);
        }

        .dialogue-text {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .dialogue-actions {
            display: flex;
            gap: 10px;
        }

        /* å½•éŸ³åŒºåŸŸ */
        .recording-section {
            background: #F8FAFC;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #0DA271;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
        }

        .btn-recording {
            background-color: var(--error);
            animation: pulse 1.5s infinite;
        }

        .btn-secondary {
            background-color: var(--surface);
            color: var(--text);
            border: 1px solid #E2E8F0;
            flex: 1;
        }

        .btn-secondary:hover {
            background-color: #F7FAFC;
        }

        .recording-status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            display: none;
        }

        .recording-active {
            background-color: #FEF3C7;
            border: 1px solid var(--warning);
            color: var(--warning);
            display: block;
        }

        .accuracy-display {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: linear-gradient(135deg, #E0F2FE, #A7F3D0);
        }

        /* ç»Ÿè®¡é¢æ¿ */
        .stats-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }

        .stat-item h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-item p {
            font-size: 12px;
            opacity: 0.9;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            #animationVideo {
                height: 250px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .dialogue-actions {
                flex-direction: column;
            }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ åŠ¨ç”»è‹±è¯­è·Ÿè¯»æ‰“å¡</h1>
        <p class="subtitle">è§‚çœ‹åŠ¨ç”» Â· è·Ÿè¯»å°è¯ Â· æå‡å£è¯­</p>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-panel">
            <div class="stats-grid">
                <div class="stat-item">
                    <h3 id="completedCount">0</h3>
                    <p>å·²å®Œæˆå°è¯</p>
                </div>
                <div class="stat-item">
                    <h3 id="totalCount">0</h3>
                    <p>æ€»å°è¯æ•°</p>
                </div>
                <div class="stat-item">
                    <h3 id="averageAccuracy">0%</h3>
                    <p>å¹³å‡å‡†ç¡®ç‡</p>
                </div>
            </div>
        </div>

        <!-- åŠ¨ç”»æ’­æ”¾åŒºåŸŸ -->
        <div class="video-section">
            <div class="video-container">
                <video id="animationVideo" controls>
                    <source src="#" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
            </div>
            <div class="subtitle-display">
                <span id="currentSubtitle">è¯·é€‰æ‹©è¦è·Ÿè¯»çš„å°è¯å¼€å§‹ç»ƒä¹ </span>
            </div>
        </div>

        <!-- å½•éŸ³åŒºåŸŸ -->
        <div class="recording-section">
            <h3>ğŸ¤ è·Ÿè¯»ç»ƒä¹ </h3>
            <div id="recordingStatus" class="recording-status">
                <div>â— å½•éŸ³ä¸­... <span id="recordingTimer">0</span>ç§’</div>
            </div>
            <div id="accuracyDisplay" class="accuracy-display" style="display: none;">
                å‡†ç¡®ç‡: <span id="accuracyValue">0</span>%
            </div>
            <div class="dialogue-actions">
                <button class="btn btn-primary" id="recordBtn">å¼€å§‹è·Ÿè¯»å½•éŸ³</button>
                <button class="btn btn-secondary" id="playbackBtn" disabled>æ’­æ”¾æˆ‘çš„å½•éŸ³</button>
            </div>
        </div>

        <!-- å°è¯åˆ—è¡¨ -->
        <div class="dialogues-section">
            <h3>ğŸ“ åŠ¨ç”»å°è¯</h3>
            <div id="dialoguesList">
                <!-- å°è¯åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å®ŒæˆæŒ‰é’® -->
        <button class="btn btn-primary" id="completeBtn" style="width: 100%; margin-top: 20px;" disabled>
            âœ… å®Œæˆä»Šæ—¥æ‰“å¡
        </button>
    </div>

    <script>
        // ç¤ºä¾‹åŠ¨ç”»å°è¯æ•°æ®
        const animationData = {
            title: "å°çŒªä½©å¥‡ - International Day",
            dialogues: [
                {
                    startTime: 10,
                    endTime: 15,
                    character: "Peppa",
                    text: "I'm France! George is Russia. Pedro is America.",
                    keywords: ["france", "russia", "america"]
                },
                {
                    startTime: 16,
                    endTime: 20,
                    character: "Suzy",
                    text: "Hello! That's Dutch for hello.",
                    keywords: ["hello", "dutch"]
                },
                {
                    startTime: 25,
                    endTime: 30,
                    character: "Children",
                    text: "Peace and harmony in all the world.",
                    keywords: ["peace", "harmony", "world"]
                },
                {
                    startTime: 35,
                    endTime: 40,
                    character: "Pedro",
                    text: "I'm building a big sand castle!",
                    keywords: ["building", "sand", "castle"]
                },
                {
                    startTime: 45,
                    endTime: 50,
                    character: "Madame Gazelle",
                    text: "What do all the countries of the world do?",
                    keywords: ["countries", "world"]
                }
            ]
        };

        // DOM å…ƒç´ 
        const video = document.getElementById('animationVideo');
        const currentSubtitle = document.getElementById('currentSubtitle');
        const dialoguesList = document.getElementById('dialoguesList');
        const recordBtn = document.getElementById('recordBtn');
        const playbackBtn = document.getElementById('playbackBtn');
        const completeBtn = document.getElementById('completeBtn');
        const recordingStatus = document.getElementById('recordingStatus');
        const accuracyDisplay = document.getElementById('accuracyDisplay');
        const accuracyValue = document.getElementById('accuracyValue');
        const recordingTimer = document.getElementById('recordingTimer');
        const completedCount = document.getElementById('completedCount');
        const totalCount = document.getElementById('totalCount');
        const averageAccuracy = document.getElementById('averageAccuracy');

        // çŠ¶æ€å˜é‡
        let currentDialogue = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingSeconds = 0;
        let recordingTimerInterval = null;
        let dialoguesState = {};

        // åˆå§‹åŒ–
        function initializeApp() {
            renderDialoguesList();
            updateStatistics();
            setupEventListeners();
        }

        // æ¸²æŸ“å°è¯åˆ—è¡¨
        function renderDialoguesList() {
            dialoguesList.innerHTML = '';
            animationData.dialogues.forEach((dialogue, index) => {
                const dialogueElement = document.createElement('div');
                dialogueElement.className = 'dialogue-item';
                dialogueElement.innerHTML = `
                    <div class="dialogue-header">
                        <span class="character">${dialogue.character}</span>
                        <span class="dialogue-status status-pending" id="status-${index}">å¾…å®Œæˆ</span>
                    </div>
                    <div class="dialogue-text">${dialogue.text}</div>
                    <div class="dialogue-actions">
                        <button class="btn btn-secondary" onclick="selectDialogue(${index})">é€‰æ‹©è·Ÿè¯»</button>
                        <button class="btn btn-secondary" onclick="playDialogue(${index})">æ’­æ”¾ç‰‡æ®µ</button>
                    </div>
                `;
                dialoguesList.appendChild(dialogueElement);
                
                // åˆå§‹åŒ–çŠ¶æ€
                dialoguesState[index] = {
                    completed: false,
                    accuracy: 0,
                    audioUrl: null
                };
            });
            
            totalCount.textContent = animationData.dialogues.length;
        }

        // é€‰æ‹©å°è¯
        function selectDialogue(index) {
            currentDialogue = animationData.dialogues[index];
            
            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.dialogue-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.dialogue-item')[index].classList.add('active');
            
            // æ›´æ–°å½“å‰å­—å¹•
            currentSubtitle.innerHTML = `<span class="current-subtitle">${currentDialogue.character}:</span> ${currentDialogue.text}`;
            
            // å¯ç”¨å½•éŸ³æŒ‰é’®
            recordBtn.disabled = false;
            recordBtn.textContent = 'ğŸ¤ å¼€å§‹è·Ÿè¯»å½•éŸ³';
        }

        // æ’­æ”¾å°è¯ç‰‡æ®µ
        function playDialogue(index) {
            const dialogue = animationData.dialogues[index];
            alert(`æ’­æ”¾ ${dialogue.character} çš„å°è¯: "${dialogue.text}"\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè·³è½¬åˆ°è§†é¢‘çš„å¯¹åº”æ—¶é—´ç‚¹`);
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ§åˆ¶è§†é¢‘è·³è½¬åˆ°å¯¹åº”æ—¶é—´
            // video.currentTime = dialogue.startTime;
            // video.play();
        }

        // å¼€å§‹/åœæ­¢å½•éŸ³
        recordBtn.addEventListener('click', async function() {
            if (!currentDialogue) {
                alert('è¯·å…ˆé€‰æ‹©è¦è·Ÿè¯»çš„å°è¯');
                return;
            }

            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true
                        } 
                    });
                    
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        
                        // æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«å’Œåˆ†æ
                        const accuracy = await analyzePronunciation(audioBlob, currentDialogue.text);
                        
                        // æ›´æ–°çŠ¶æ€
                        const currentIndex = animationData.dialogues.findIndex(d => d === currentDialogue);
                        dialoguesState[currentIndex] = {
                            completed: true,
                            accuracy: accuracy,
                            audioUrl: URL.createObjectURL(audioBlob)
                        };
                        
                        // æ›´æ–°UI
                        updateDialogueStatus(currentIndex, accuracy);
                        updateStatistics();
                        
                        // å¯ç”¨æ’­æ”¾æŒ‰é’®
                        playbackBtn.disabled = false;
                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.textContent = 'â¹ï¸ åœæ­¢å½•éŸ³';
                    recordBtn.classList.add('btn-recording');
                    recordingStatus.style.display = 'block';
                    
                    // å¼€å§‹è®¡æ—¶
                    recordingSeconds = 0;
                    recordingTimerInterval = setInterval(() => {
                        recordingSeconds++;
                        recordingTimer.textContent = recordingSeconds;
                    }, 1000);
                    
                } catch (error) {
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.textContent = 'ğŸ¤ å¼€å§‹è·Ÿè¯»å½•éŸ³';
                recordBtn.classList.remove('btn-recording');
                recordingStatus.style.display = 'none';
                clearInterval(recordingTimerInterval);
            }
        });

        // æ’­æ”¾ç”¨æˆ·å½•éŸ³
        playbackBtn.addEventListener('click', function() {
            const currentIndex = animationData.dialogues.findIndex(d => d === currentDialogue);
            const audio = new Audio(dialoguesState[currentIndex].audioUrl);
            audio.play();
        });

        // åˆ†æå‘éŸ³å‡†ç¡®æ€§ï¼ˆæ¨¡æ‹Ÿï¼‰
        async function analyzePronunciation(audioBlob, targetText) {
            // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨çœŸå®çš„è¯­éŸ³è¯†åˆ«API
            // ç°åœ¨ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            const baseAccuracy = Math.random() * 30 + 60; // 60-90% çš„éšæœºå‡†ç¡®ç‡
            return Math.min(100, Math.round(baseAccuracy));
        }

        // æ›´æ–°å°è¯çŠ¶æ€
        function updateDialogueStatus(index, accuracy) {
            const statusElement = document.getElementById(`status-${index}`);
            const dialogueElement = document.querySelectorAll('.dialogue-item')[index];
            
            statusElement.textContent = `${accuracy}%`;
            statusElement.className = 'dialogue-status status-completed';
            dialogueElement.classList.add('completed');
            
            // æ˜¾ç¤ºå‡†ç¡®ç‡
            accuracyDisplay.style.display = 'block';
            accuracyValue.textContent = accuracy;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            const completed = Object.values(dialoguesState).filter(state => state.completed).length;
            const total = animationData.dialogues.length;
            const accuracies = Object.values(dialoguesState)
                .filter(state => state.completed)
                .map(state => state.accuracy);
            
            const avgAccuracy = accuracies.length > 0 
                ? Math.round(accuracies.reduce((a, b) => a + b) / accuracies.length)
                : 0;
            
            completedCount.textContent = completed;
            totalCount.textContent = total;
            averageAccuracy.textContent = `${avgAccuracy}%`;
            
            // å¦‚æœæ‰€æœ‰å°è¯éƒ½å®Œæˆäº†ï¼Œå¯ç”¨å®ŒæˆæŒ‰é’®
            completeBtn.disabled = completed !== total;
        }

        // å®Œæˆæ‰“å¡
        completeBtn.addEventListener('click', function() {
            const finalAccuracy = parseInt(averageAccuracy.textContent);
            let message = `ğŸ‰ æ­å–œå®Œæˆä»Šæ—¥æ‰“å¡ï¼\n\n`;
            message += `å®Œæˆå°è¯: ${completedCount.textContent}/${totalCount.textContent}\n`;
            message += `å¹³å‡å‡†ç¡®ç‡: ${finalAccuracy}%\n\n`;
            
            if (finalAccuracy >= 80) {
                message += `ğŸŒŸ è¡¨ç°ä¼˜ç§€ï¼å‘éŸ³å¾ˆæ ‡å‡†ï¼`;
            } else if (finalAccuracy >= 60) {
                message += `ğŸ‘ è¿˜ä¸é”™ï¼Œç»§ç»­åŠ æ²¹ï¼`;
            } else {
                message += `ğŸ’ª éœ€è¦å¤šç»ƒä¹ ï¼ŒåšæŒå°±æ˜¯èƒœåˆ©ï¼`;
            }
            
            alert(message);
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // è§†é¢‘æ—¶é—´æ›´æ–°ç›‘å¬ï¼ˆåœ¨å®é™…åº”ç”¨ä¸­ç”¨äºåŒæ­¥å­—å¹•ï¼‰
            video.addEventListener('timeupdate', function() {
                // è¿™é‡Œå¯ä»¥å®ç°å­—å¹•çš„è‡ªåŠ¨åˆ‡æ¢
            });
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
